# ==============================================================================
# Docker Compose Configuration for Full-Stack Application
# ==============================================================================
# PURPOSE: Orchestrate frontend (React) and backend (Go) services with security
# 
# SERVICES:
#   - frontend: React app served on port 5000 (non-root)
#   - backend: Go API server on port 8080 (non-root)
#
# USAGE:
#   Start:     docker-compose up -d
#   Stop:      docker-compose down
#   Logs:      docker-compose logs -f
#   Rebuild:   docker-compose up -d --build
#
# NETWORK: Services communicate via 'app-network' bridge network
# ==============================================================================

version: '3.8'

services:
  # ============================================================================
  # Backend Service - Go API Server
  # ============================================================================
  backend:
    build:
      context: ./example-backend
      dockerfile: Dockerfile
      args:
        # Configure CORS to allow frontend origin
        REQUEST_ORIGIN: http://localhost:5000
    container_name: backend-server
    ports:
      - "8080:8080"
    environment:
      # Application port (matches EXPOSE in Dockerfile)
      - PORT=8080
      # CORS origin (can override build arg at runtime)
      - REQUEST_ORIGIN=http://localhost:5000
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================================================
  # Frontend Service - React Application
  # ============================================================================
  frontend:
    build:
      context: ./example-frontend
      dockerfile: Dockerfile
      args:
        # Configure backend API endpoint
        REACT_APP_BACKEND_URL: http://localhost:8080
    container_name: frontend-app
    ports:
      - "5000:5000"
    environment:
      # Backend API URL (for client-side requests)
      - REACT_APP_BACKEND_URL=http://localhost:8080
    networks:
      - app-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

# ==============================================================================
# Networks Configuration
# ==============================================================================
networks:
  app-network:
    driver: bridge
    name: secure-app-network